machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

checkout:
  post:
    - git submodule sync
    - git submodule update --init --remote

dependencies:
  # CircleCi will magically install pip and cache pip dependencies in requirements.txt
  # Cache the resolution-cache and build streams to speed things up
  cache_directories:
    - "~/.sbt"
    - "target/resolution-cache"
    - "project/target/resolution-cache"

test:
  override:
    - sbt test
    - sbt dockerComposeTest

deployment:
  uat_and_prd:
    branch: master
    owner: ovotech
    commands:
      - ci_scripts/publish_docker_image.sh
      - ci_scripts/deploy_to_ecs.sh -s composer UAT aws/container-definition.json
      - ci_scripts/send_librato_deployment_event.sh
      - ci_scripts/comment_on_last_merged_pr.sh

experimental:
  notify:
    branches:
      only:
        - master
